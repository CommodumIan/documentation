# Vega Chain
Vega uses Tendermint as a consensus layer to form a blockchain. The rest of the information here informs on how that blockchain and its relevant components is comprised. For more information on how Vega bridges to Ethereum, see (link). 

## Delegated proof of stake
Vega runs on a delegated proof of stake blockchain. Participants who hold a balance of VEGA, the governance asset, can stake that asset on the network by nominating their tokens to one or more validators that they trust to help secure the network. 

In a delegated proof of stake system, participants - validators and token-holders - use their VEGA tokens (or fractions of a token) to nominate a validator node. Validators (link) run the network, and non-validator participants assign the voting rights of their VEGA tokens to endorse a validator's trustworthiness. Everyone participating in staking is rewarded for keeping the network running (and penalised for not meeting the requirements of running the network). 

<!-- Penalties: 
- Validators can lose their VEGA to the network if they don't meet the requirements or prove to be bad actors. The tokens are sent to the insurance pool. (link to insurance pool section when available) 
- Nominators will lose future rewards
-->

### ***Further reading***
Link to Klaus's paper about staking and validator rewards when publicly available. (valpol)

### Staking on Vega 
Vega networks use the ERC20 token VEGA for staking. Staking requires the combined action of associating VEGA tokens (or fractions of a token) to the Vega staking bridge contract; and using those token(s) to nominate one or more validators. 

**VEGA token**
A VEGA token (or fraction) can be either unassociated or associated:

- Unassociated: The tokenholder is free to do what they want with the token, but cannot nominate a validator with it
- Associated: The token is locked in the staking smart contract and can be used to nominate a validator. It must be unassociated to withdraw it

All tokens, whether unlocked or locked in the vesting contract can be used for staking.
All tokens, whether associated or unassociated, can be used to vote on governance actions. 

**Staking actions** 
All actions regarding staking are initiated by the Vega staking bridge smart contract (not by the Vega protocol). The staking bridge contains functions enabling users to deposit, remove, and transfer stake by moving the governance tokens from their wallet to the staking bridge. The staking bridge contract is used for staking unlocked tokens. In the case of locked tokens, the Vega node interacts with the ERC20 vesting contract, which holds locked tokens,(link), and provides the same utility as the staking bridge smart contract. 

The Vega network will be made aware of how many tokens a given party has associated through bridge events, and when those same tokens are unassociated, a corresponding event is emitted. Vega uses this information to keep track of total nominatable stake, unnominated stake, stake per validator, stake per validator marked for nomination in the next epoch, and total stake. These events are only registered after a certain number of block confirmations defined by the network parameter `blockchains.ethereumConfig`. 

(Link to autogenerated API sections for each for how people can see their staking balance - need to find out what they are) 

#### ***Further reading*** 
The staking bridge contracts can be found on the [Staking Bridge repository] on GitHub. (https://github.com/vegaprotocol/Staking_Bridge).

#### Staking on alpha mainnet
For alpha mainnet, all rewards are evenly distributed among validators and nominators. 

Validators will not lose stake or rewards if they have a temporary interruption of service. (What happens if a validator really messes up?) 

<< tip: VEGA tokenholders can associate their tokens and then nominate validators to receive rewards, using token.vega.xyz, or CoinList, depending on how they acquired their tokens. All tokens, whether locked in the vesting contract or unlocked, can be used for staking. >>

#### Staking rewards
Validators and nominators both receive incentives from the network, depending on various factors including how much stake is nominated. Read about rewards for staking on alpha mainnet under Validators, below. (link) 

### Delegating and undelegating (WIP)
Any locked and undelegated stake can be delegated at any time by putting a delegation-message on the chain. However, the delegation only becomes valid towards the next epoch, though it can be undone through undelegate.

Once Vega is aware of locked tokens, the users will have an account with the balance reflecting how many tokens were locked. At this point, the user can submit a transaction to use their tokens to nominate validators.

```proto
message Delegate {
	uint256   Amount = 1;
	Validator Val = 2;
}

message Undelegate {
	uint256   Amount = 1;
	Validator Val = 2;
}
```

Where `Delegate` adds the `Amount` to the delegation of validator `Val` at the beginning of the next epoch (if still available to them), and `Undelegate` subtracts the amount from the delegation of `Val` by the next epoch if available.

To avoid fragmentation or spam, there is a system parameter `minimum delegateable stake` that defines the smallest unit (fractions of) tokens that can be used for delegation.

To delegate stake, a delegator simply puts a command "delegate x stake to y" on the chain. It is verified at the beginning (when the command is issued and before it is put on the chain) that the delegator has sufficient unlocked stake, as well as in the beginning of the next epoch just before the command takes effect. The amount of delegatable stake is reduced right away once the command is put into a block.

Each validator will have a maximum amount of stake that they can accept as delegation (initially this will be the same for all validators, governed by a network parameter `maxStakePerValidator`). If a participant is delegating such that the size of their stake would cause this amount to be exceeded, then they are only staked up to this maximum amount. The remaining of their stake is therefore eligible to stake to another validator.

Users can remove stake by submitting an `undelegate` transaction. The tokens will then be restored back to their token balance.

At the top level, `Stake_Deposited` simply adds `amount` of tokens to the account of the user associated with the `user`. Likewise, the `Stake_Removed` event subtracts the `amount` of tokens from their account.

- If the `Stake_Removed` amount of tokens is higher than the balance of said user, something went seriously wrong somewhere. This is a good time to panic.
- If the amount is higher than the amount of undelegated stake, the missing amount must be freed using the undelegate function (see section above about bridge contract interaction). There is currently no rule how to choose this;

*Option-1*
A first heuristic would be to take from the highest delegation first and then go down, e.g.
	* If the delegation is 100, 90, 80, 70, and we need to free 30 stake, we first take from the richest ones until they are no longer the richest:
	* Free 10, delegation is 90, 90, 80, 70
	* Free 30, delegation is 80, 80, 80, 70
This has the benefit of lowering the probability that a single withdrawal will leave any one validator with zero delegated stake.

*Option-2*
Another option would be to withdraw stake proportionally from the validators.
	* If the delegation is 100, 90, 80, 70, and we need to free 30 stake, we split the withdrawal across all validators proportionately:
	* Free from delegator-1 (to whom the participant has delegated 100) an amount equal to 30 * (100/(100+90+80+70)) etc. Not sure how to deal with rounding.


#### Types of undelegations (WIP)

_Undelegate towards the end of the epoch_
- The action is announced in the next available block, but the delegator keeps the delegation alive till the last block of the epoch. The delegator can then re-delegate the stake, which then be valid once the next epoch starts. The delegator cannot move the tokens before the epoch ends, they remain locked.


_Undelegate Now_
`UndelegateNow`
The action can be announced at any time and is executed immediately following the block it is announced in.
The user is marked to not receive any reward from the validator in that epoch. The reward should instead go into the `on-chain treasury account for that asset` (TODO: add link). The stake is marked as free for the delegator, but is not yet removed from the validator stake (this happens at the end of the epoch).

#### Auto [Un]delegation (WIP)
- A party become eligible to participate in auto delegation once they have manually delegated (nominated) 95%+ of the association.
- Once entering auto delegation mode, any un-nominated associated tokens will be automatically distributed according to the current validator nomination of the party maintaining the same proportion.
- Edge cases:
  - If a party has entered auto delegation mode, and their association has increased it should be automatically distributed for the epoch following the increase of association. However, if during the same epoch the party requests to execute manual delegation, no automatic delegation will be done in that epoch. If there is still un-nominated association in the next epoch, it will be automatically distributed.
  - If a party qualifies for auto delegation and has un-nominated association, however the party requests to undelegate (either during the epoch or at the end of the epoch) - they exit auto delegation mode. The rationale here is that they probably want to do some rearrangement of their nomination and we give them a chance to do so. Once the party reached more than x% of nomination again, they would enter auto delegation mode again and any future un-nominated association will be automatically distributed.
  - When distributing the newly available association according to the current validators nomination of the party, if validator A should get X but can only accept X - e (due to max per validator constraint), Vega will not try to distribute e between the other validators and will try to distribute it again in the next round.
- Auto undelegation - whenever the party dissociates tokens, their nomination must be updated such that their maximum nomination reflects the association.

### ERC20 governance and staking token (restricted mainnet)

Vega uses an ERC20 token called VEGA for governance. This includes nominating validators, and creating and voting on governance proposals.

<< tip >> A party's VEGA tokens must first be recognised against a Vega public key before they can be used on the Vega network for governance and staking. << tip >>

The VEGA token system *(better word?)* and contract allows VEGA to be staked to a Vega public key without any action on the Vega network, and without putting the tokens under the control of the Vega network.

Using this approach means:
- Locked (unvested) tokens can be staked. Both staking and unstaking are controlled entirely on the Ethereum side, and staked balances are recognised on the Vega network by listening for `Stake_*` events that can be emitted by any contract that's recognised by the network. This makes it possible to implement staking (nomination and denomination) functionality into the token vesting contract in addition to the ERC20 staking contract.
- Any attacker who gains control of, or is able to exploit, the Vega network will be unable to steal staked VEGA tokens. Even if an attacker was able to take over the network, the tokenholders would remain unaffected and could fix the issue and relaunch the network by delegating to new validators.

## Validators

Validators are responsible for agreeing on the order of transactions and creating new blocks so that all nodes can agree on the state of the network. In alpha mainnet, all validators effectively have the same stake currently, so all are selected an equal number of times to validate a block. Thus rewards will be equal between them, assuming they all continue to function.  

### Rewards for validators and stakers (alpha mainnet) 

At the end of an epoch, reward payments are calculated. This is done per active validator. A reward is calculated per validator, and for each validator the reward is divided between their nominators. 

### ***Further reading*** 
Read [Validator and Staking POS Rewards](https://github.com/vegaprotocol/specs/blob/main/protocol/0058-simple-POS-rewards.md) for full details for how rewards are calculated. 

## Network life (alpha mainnet)
Vega networks will, at least initially, run for a limited time only. 

There are several reasons for this decision, including: 

- Limited network life makes it efficient to upgrade the protocol by starting again, as it avoids the need to deal with multiple versions of the code. Upgrades to a running chain need to respect and be able to recalculate the deterministic state for earlier blocks, so all versions of criticial code must remain in the system. 
- It allows for rapid iteration, as the ability to start new chains for new features is simpler.
- Once there is a network with trading, the thousands of transactions per second will generate a lot of data. Given that most instruments expire, this allows for new markets to be created on a new chain, allowing an old market/chain to come to an end rather than keeping the history and data forever.

### Network checkpoints 

The network's validators periodically store checkpoints of all important state parameters such as balances and governance proposals. This allows the chain to be restarted from a previously valid state in the event of a critical issue being discovered, or consensus failure. Those checkpoints happen at defined intervals, and additionally on every deposit and withdrawal request. Each validator node calculates the hash of the checkpoint file and then sends this through consensus to ensure all the nodes in the network agree on the state. 

Once a network is taken down, the checkpoint file's hash is added to the genesis block. At network start-up, a validator must submit a restore transaction with the checkpoint file. All other validators verify the checkpoint against their own, restore the state and then allow other transactions on the network. 

For a full list of data stored in a checkpoint, see SPECS LINK. 

## Tendermint consensus
 ### Transaction and sequencing
 ### Transaction ordering
## Fast syncing (Snapshots) 
## Fairness (Wendy)
